<!DOCTYPE html>
<html>
<head>
  <style>
    .board-container,
    .status-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 100%;
    }

    .status-container {
      margin-top: 20px;
    }

    .status-container > div {
      margin-bottom: 10px;
    }

    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>chessboardjs Example #5000 - Only Allow Legal Moves</title>
  <base href="../" />
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
    integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" 
    crossorigin="anonymous"
  >
</head>
<body>
  <div class="board-container">
    <div id="myBoard" style="width: 100%; max-width: 400px;"></div>
    <div class="status-container">
      <label>Status:</label>
      <div id="status"></div>
      <label>FEN:</label>
      <div id="fen"></div>
      <label>PGN:</label>
      <div id="pgn"></div>
    </div>
  </div>

  <script src="https://chessboardjs.com/js/jquery-3.4.1.min.js"></script>
  <script 
    src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
    integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
    crossorigin="anonymous"
  ></script>
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"
    integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz"
    crossorigin="anonymous"
  ></script>
  <script>
    var board = null;
var game = new Chess();
var $status = $('#status');
var $fen = $('#fen');
var $pgn = $('#pgn');
var gameId = null;

function startWebSocket(gameId) {
    let protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/api/v1/game/ws/${gameId}`);

    ws.onmessage = (event) => {
        const receivedFen = event.data;
        if (game.fen() !== receivedFen) {
            game.load(receivedFen);
            board.position(receivedFen, false);
            updateStatus();
        }
    };

    ws.onerror = (error) => {
        console.error(`WebSocket Error: ${error}`);
    };

    ws.onclose = () => {
        console.log('WebSocket closed. Attempting to reconnect...');
        setTimeout(() => startWebSocket(gameId), 1000);
    };
}


async function startGame() {
    const response = await fetch('/api/v1/game/start_game', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    const data = await response.json();
    gameId = data.id;
}

async function sendMove(move) {
    const action = {
        action_type: 'MOVE',
        move: move.san
    };

    const response = await fetch(`/api/v1/game/${gameId}/action`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(action)
    });

    if (response.ok) {
        const data = await response.json();
        return data;
    } else {
        return null;
    }
}

function onDragStart(source, piece, position, orientation) {
    if (game.game_over()) return false;

    if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
        (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
    }

    var moves = game.moves({
        square: source,
        verbose: true
    });

    $('#myBoard .square-55d63').css('background', '');

    for (var i = 0; i < moves.length; i++) {
        var squareEl = $('#myBoard .square-' + moves[i].to);

        var dot = $('<div>').css({
            width: '10px',
            height: '10px',
            backgroundColor: 'blue',
            borderRadius: '50%',
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)'
        }).addClass('blue-dot');
        
        squareEl.append(dot);
    }
}

async function onDrop(source, target) {
    $('#myBoard .square-55d63').css('background', '');
    $('.blue-dot').remove();

    var move = game.move({
        from: source,
        to: target,
        promotion: 'q'
    })

    if (move === null) return 'snapback';

    const moveResponse = await sendMove(move);

    if (moveResponse === null) {
        game.undo();
        return 'snapback';
    }

    updateStatus();
}

function onSnapEnd() {
    board.position(game.fen());
}

function updateStatus() {
    var status = '';
    var moveColor = 'White';

    if (game.turn() === 'b') {
        moveColor = 'Black';
    }

    if (game.in_checkmate()) {
        status = 'Game over, ' + moveColor + ' is in checkmate.';
    } else if (game.in_draw()) {
        status = 'Game over, drawn position';
    } else {
        status = moveColor + ' to move';

        if (game.in_check()) {
            status += ', ' + moveColor + ' is in check';
        }
    }

    $status.html(status);
    $fen.html(game.fen());
    $pgn.html(game.pgn());
}

var config = {
    draggable: true,
    position: 'start',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd,
    moveSpeed: 1,
    snapbackSpeed: 1,
    snapSpeed: 1,
    appearspeed: 'fast',
    pieceTheme: 'https://raw.githubusercontent.com/oakmac/chessboardjs/master/website/img/chesspieces/alpha/{piece}.png',
};

function getBoardWidth() {
    const { innerWidth, innerHeight } = window;
    const smallerDimension = Math.min(innerWidth, innerHeight);
    return smallerDimension - 10;
}

const boardWidth = getBoardWidth();
$('#myBoard').css('width', `${boardWidth}px`);

board = Chessboard('myBoard', config);

function getGameIdFromHash() {
    return location.hash.substr(1);
}

async function loadPosition(gameId) {
    const response = await fetch(`/api/v1/game/${gameId}`);

    if (response.ok) {
        const data = await response.json();
        const position = data.fen;
        game.load(position);
        board.position(game.fen());
    }
}

function getGamePosition() {
    fetch(`/api/v1/game/${gameId}`)
        .then(response => response.json())
        .then(data => {
            const fen = data.fen;
            console.log("Received FEN:", fen);  // Add a console log here to debug
            if (game.fen() !== fen) {
                game.load(fen);
                board.position(fen, false);  // Add 'false' to avoid animation
                updateStatus();
                console.log("Board updated to new position");  // Add a console log here to debug
            }
        })
        .catch(error => console.log('An error has occurred: ', error));
}


(async function () {
    gameId = getGameIdFromHash();

    if (!gameId) {
        await startGame();
        location.hash = `#${gameId}`;
    } else {
        await loadPosition(gameId);
    }

    startWebSocket(gameId);  // Start the WebSocket connection

    updateStatus();
})();

  </script>
</body>
</html>
